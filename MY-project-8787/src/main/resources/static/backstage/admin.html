<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">

<title>管理者後台</title>
<meta content="" name="description">
<meta content="" name="keywords">

<!-- Favicons -->
<!-- <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon"> -->

<!-- Google Fonts -->
<link
	href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
	rel="stylesheet">

<!-- Vendor CSS Files -->
<link href="assets/vendor/aos/aos.css" rel="stylesheet">
<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
	rel="stylesheet">
<link href="assets/vendor/boxicons/css/boxicons.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css" />
<link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

<!-- Template Main CSS File -->
<link href="assets/css/style.css" rel="stylesheet">

</head>

<body>

	<!-- ======= Mobile nav toggle button ======= -->
	<i class="bi bi-list mobile-nav-toggle d-xl-none"></i>

	<!-- ======= Header ======= -->
	<header id="header">
		<div class="d-flex flex-column">

			<div class="profile">
				<img src="assets/img/profile-img.jpg" alt=""
					class="img-fluid rounded-circle">
				<h1 class="text-light">
					<a href="/backstage/admin.html">管理者您好</a>
				</h1>
			</div>

			<nav id="navbar" class="nav-menu navbar">
				<!-- <ul>
					<li><a href="/backstage/admin.html"
						class="nav-link scrollto active"><i class="bx bx-server"></i>
							<span>管理者後台</span></a></li>
				</ul> -->
				<ul>
					<li><a href="#reservationPreview"
						class="nav-link scrollto active"><i class="bx bx-server"></i>
							<span>預約資料一覽</span></a></li>
				</ul>
				<ul>
					<li><a href="#userPreview" class="nav-link scrollto active"><i
							class="bx bx-server"></i> <span>使用者資料一覽</span></a></li>
				</ul>
				<ul>
					<li><a href="#userAnalysis" class="nav-link scrollto active"><i
							class="bx bx-server"></i> <span>使用者資料分析</span></a></li>
				</ul>
				<ul>
					<li><a href="#reservationAnalysis"
						class="nav-link scrollto active"><i class="bx bx-server"></i>
							<span>預約資料分析</span></a></li>

				</ul>
			</nav>
			<!-- .nav-menu -->
		</div>
	</header>
	<!-- End Header -->

	<main id="main">

		<!-- ======= Breadcrumbs ======= -->
		<section class="breadcrumbs">
			<div class="container">

				<div class="d-flex justify-content-between align-items-center">
					<h2>管理者後台</h2>
					<!--<ol>
                        <li><a href="/backstage/index.html">管理者後台</a></li>
                        <li>管理者後台</li>
                    </ol>-->
				</div>

			</div>
		</section>
		<!-- End Breadcrumbs -->

		<section class="inner-page" id="reservationPreview">
			<div class="container">
				<h2>預約資料一覽</h2>
				<table id="reservationTable" class="display">
					<thead>
						<tr>
							<th>ID</th>
							<th>電子郵件</th>
							<th>場地</th>
							<th>日期</th>
							<th>時間</th>
							<th>是否借用球具</th>
							<th>修改</th>
							<th>刪除</th>
						</tr>
					</thead>
					<tbody>
						<!-- Data will be populated here -->
					</tbody>
				</table>
				<!-- Button to trigger modal -->
				<button id="addReservationButton" class="btn btn-primary">新增預約</button>

				<div class="mb-3">
					<button id="downloadReservationTable" class="btn btn-primary mt-3">下載預約表格</button>
				</div>

				<!-- Modal for adding/updating reservation -->
				<div class="modal fade" id="reservationModal" tabindex="-1"
					aria-labelledby="modalTitle" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="modalTitle">新增預約</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<form id="reservationForm">
									<input type="hidden" id="reservationId">
									<div class="mb-3">
										<label for="email" class="form-label">電子郵件:</label> <input
											type="email" class="form-control" id="email" name="email"
											required>
									</div>
									<div class="mb-3">
										<label for="field" class="form-label">場地:</label>
										<!-- <input
											type="text" class="form-control" id="field" name="field"
											required> -->
										<select class="form-control" id="field" name="field" required>
											<option value="第一羽毛球場">第一羽毛球場</option>
											<option value="第二羽毛球場">第二羽毛球場</option>
											<option value="第三羽毛球場">第三羽毛球場</option>
											<option value="第一壁球球場">第一壁球球場</option>
											<option value="第二壁球球場">第二壁球球場</option>
											<option value="第三壁球球場">第三壁球球場</option>
											<option value="第一桌球桌">第一桌球桌</option>
											<option value="第二桌球桌">第二桌球桌</option>
											<option value="第三桌球桌">第三桌球桌</option>
											<option value="第一撞球桌">第一撞球桌</option>
											<option value="第二撞球桌">第二撞球桌</option>
											<option value="第三撞球桌">第三撞球桌</option>
										</select>

									</div>
									<div class="mb-3">
										<label for="date" class="form-label">日期:</label> <input
											type="date" class="form-control" id="date" name="date"
											required>
									</div>
									<div class="mb-3">
										<label for="time" class="form-label">時間:</label>
										<!--<input
											type="time" class="form-control" id="time" name="time"
											required>  -->
										<select class="form-control" id="time" name="time" required>
											<option value="" disabled selected>選擇預約時間</option>
											<option value="08:00-09:00">08:00-09:00</option>
											<option value="09:00-10:00">09:00-10:00</option>
											<option value="10:00-11:00">10:00-11:00</option>
											<option value="11:00-12:00">11:00-12:00</option>
											<option value="12:00-13:00">12:00-13:00</option>
											<option value="13:00-14:00">13:00-14:00</option>
											<option value="14:00-15:00">14:00-15:00</option>
											<option value="15:00-16:00">15:00-16:00</option>
											<option value="16:00-17:00">16:00-17:00</option>
											<option value="17:00-18:00">17:00-18:00</option>
											<option value="19:00-20:00">19:00-20:00</option>
											<option value="21:00-22:00">21:00-22:00</option>
										</select>
									</div>
									<div class="mb-3 form-check">
										<input type="checkbox" class="form-check-input" id="equipment"
											name="equipment"> <label for="equipment"
											class="form-check-label">借用球具</label>
									</div>
									<button type="submit" class="btn btn-primary">提交</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section class="inner-page" id="userPreview">
			<div class="container">
				<h2>使用者資料一覽</h2>
				<table id="userTable" class="display">
					<thead>
						<tr>
							<th>ID</th>
							<th>姓名</th>
							<th>性別</th>
							<th>生日</th>
							<th>手機</th>
							<th>email</th>
							<th>修改</th>
							<th>刪除</th>
						</tr>
					</thead>
					<tbody>
						<!-- Data will be populated here -->
					</tbody>
				</table>
				<button id="downloadUserTable" class="btn btn-primary mt-3">下載使用者表格</button>

				<!-- Modal for adding/updating user -->
				<div class="modal fade" id="userModal" tabindex="-1"
					aria-labelledby="modalTitle" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="modalTitle">修改使用者資訊</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<form id="userForm">
									<input type="hidden" id="userId">
									<div class="mb-3">
										<label for="user-name" class="form-label">姓名:</label> <input
											type="text" class="form-control" id="user-name"
											name="user-name" required>
									</div>
									<div class="mb-3">
										<label for="user-gender" class="form-label">性別:</label> <select
											class="form-control" id="user-gender" name="user-gender"
											required>
											<option value="male">男性</option>
											<option value="female">女性</option>
											<option value="others">其他</option>
										</select>
									</div>
									<div class="mb-3">
										<label for="birthday" class="form-label">生日:</label> <input
											type="date" class="form-control" id="birthday"
											name="birthday" required>
									</div>
									<div class="mb-3">
										<label for="phone" class="form-label">手機:</label> <input
											type="text" class="form-control" id="phone" name="phone"
											required>
									</div>
									<div class="mb-3">
										<label for="email" class="form-label">電子郵件:</label> <input
											type="email" class="form-control" id="email" name="email"
											required>
									</div>
									<button type="submit" class="btn btn-primary">提交</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section class="inner-page" id="userAnalysis">
			<div class="container">
				<h2>使用者資料分析</h2>
				<div class="mb-3">
					<h4>使用者性別分析</h4>
					<div id="gender_piechart" style="width: 800px; height: 500px;"></div>
					<button id="downloadGenderChart" class="btn btn-primary mt-3">下載性別分析圖</button>
				</div>
				<div class="mb-3">
					<h4>使用者年齡分析</h4>
					<div id="age_barchart" style="width: 800px; height: 500px;"></div>
					<button id="downloadAgeChart" class="btn btn-primary mt-3">下載年齡分析圖</button>
				</div>
			</div>
		</section>

		<section class="inner-page" id="reservationAnalysis">
			<div class="container">
				<h2>預約資料分析</h2>
				<div class="mb-3">
					<h4>場地借用次數分析</h4>
					<div id="columnchart_material" style="width: 800px; height: 500px;"></div>

				</div>

				<div class="mb-3">
					<h4>借用時間頻率分析</h4>
					<div id="barchart_material" style="width: 800px; height: 500px;"></div>

				</div>
				<div class="mb-3">
					<h4>借用器具分析</h4>
					<div id="piechart_material" style="width: 800px; height: 500px;"></div>
				</div>
			</div>
		</section>
	</main>
	<!-- End #main -->


	<a href="#"
		class="back-to-top d-flex align-items-center justify-content-center"><i
		class="bi bi-arrow-up-short"></i></a>

	<!-- Vendor JS Files -->
	<script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
	<script src="assets/vendor/aos/aos.js"></script>
	<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
	<script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
	<script src="assets/vendor/typed.js/typed.umd.js"></script>
	<script src="assets/vendor/waypoints/noframework.waypoints.js"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
	<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script type="text/javascript"
		src="https://www.gstatic.com/charts/loader.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<!-- Template Main JS File -->
	<script src="assets/js/main.js"></script>


	<script>
    //for reservation preview
    $(document).ready(function() {
        const table = $('#reservationTable').DataTable({
            "ajax": {
                "url": "/api/reservations/all",
                "dataSrc": ""
            },
            "columns": [
                {"data": "id"},
                {"data": "email"},
                {"data": "field"},
                {"data": "date"},
                {"data": "time"},
                {
                    "data": "equipment",
                    "render": function(data, type, row) {
                        return data ? '是' : '否';
                    }
                },
                {
                    "data": null,
                    "defaultContent": '<button class="editButton btn btn-warning">修改</button>'
                },
                {
                    "data": null,
                    "defaultContent": '<button class="deleteButton btn btn-danger">刪除</button>'
                }
            ]
        });

        // 新增或修改預約表單提交事件
        $('#reservationForm').on('submit', function(event) {
            event.preventDefault();

            const reservationId = $('#reservationId').val();
            const reservationData = {
                email: $('#email').val(),
                field: $('#field').val(),
                date: $('#date').val(),
                time: $('#time').val(),
                equipment: $('#equipment').is(':checked')
            };

            const url = reservationId ? `/api/reservations/${reservationId}` : '/api/reservations';
            const method = reservationId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(reservationData),
                success: function(response) {
                    $('#reservationModal').modal('hide');
                    table.ajax.reload();
                },
                error: function(error) {
                    Swal.fire({
                        icon: 'error',
                        title: '操作失敗',
                        text: '操作失敗，請重試'
                    });
                }
            });
        });

        // 點擊修改按鈕事件
        $('#reservationTable tbody').on('click', '.editButton', function() {
            const data = table.row($(this).parents('tr')).data();
            $('#reservationId').val(data.id);
            $('#email').val(data.email);
            $('#field').val(data.field);
            $('#date').val(data.date);
            $('#time').val(data.time);
            $('#equipment').prop('checked', data.equipment);
            $('#modalTitle').text('修改預約');
            $('#reservationModal').modal('show');
        });

        // 點擊刪除按鈕事件
        $('#reservationTable tbody').on('click', '.deleteButton', function() {
            const data = table.row($(this).parents('tr')).data();
            Swal.fire({
                title: '確定要刪除這個預約嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '是的，刪除它！',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/api/reservations/${data.id}`,
                        method: 'DELETE',
                        success: function(response) {
                            table.ajax.reload();
                        },
                        error: function(error) {
                            Swal.fire({
                                icon: 'error',
                                title: '刪除失敗',
                                text: '刪除失敗，請重試'
                            });
                        }
                    });
                }
            });
        });

        // 點擊新增按鈕事件
        $('#addReservationButton').on('click', function() {
            $('#reservationId').val('');
            $('#reservationForm')[0].reset();
            $('#modalTitle').text('新增預約');
            $('#reservationModal').modal('show');
        });
    });

    //for user preview
    $(document).ready(function() {
        const table = $('#userTable').DataTable({
            "ajax": {
                "url": "/api/users/all",
                "dataSrc": ""
            },
            "columns": [
                {"data": "id"},
                {"data": "name"},
                {"data": "gender"},
                {"data": "birthday"},
                {"data": "phone"},
                {"data": "email"},
                {
                    "data": null,
                    "defaultContent": '<button class="editButton btn btn-warning">修改</button>'
                },
                {
                    "data": null,
                    "defaultContent": '<button class="deleteButton btn btn-danger">刪除</button>'
                }
            ]
        });

        // 新增或修改使用者表單提交事件
        $('#userForm').on('submit', function(event) {
            event.preventDefault();

            const userId = $('#userId').val();
            const userData = {
                name: $('#user-name').val(),
                gender: $('#user-gender').val(),
                birthday: $('#birthday').val(),
                phone: $('#phone').val(),
                email: $('#email').val()
            };

            const url = userId ? `/api/users/${userId}` : '/api/users';
            const method = userId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function(response) {
                    $('#userModal').modal('hide');
                    table.ajax.reload();
                },
                error: function(error) {
                    Swal.fire({
                        icon: 'error',
                        title: '操作失敗',
                        text: '操作失敗，請重試'
                    });
                }
            });
        });

        // 點擊修改按鈕事件
        $('#userTable tbody').on('click', '.editButton', function() {
            const data = table.row($(this).parents('tr')).data();
            $('#userId').val(data.id);
            $('#user-name').val(data.name);
            $('#user-gender').val(data.gender);
            $('#birthday').val(data.birthday);
            $('#phone').val(data.phone);
            $('#email').val(data.email);
            $('#modalTitle').text('修改使用者資訊');
            $('#userModal').modal('show');
        });

        // 點擊刪除按鈕事件
        $('#userTable tbody').on('click', '.deleteButton', function() {
            const data = table.row($(this).parents('tr')).data();
            Swal.fire({
                title: '確定要刪除這個使用者嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '是的，刪除它！',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({ 
                        url: `/api/users/${data.id}`,
                        method: 'DELETE',
                        success: function(response) {
                            table.ajax.reload();
                        },
                        error: function(error) {
                            Swal.fire({
                                icon: 'error',
                                title: '刪除失敗',
                                text: '刪除失敗，請重試'
                            });
                        }
                    });
                }
            });
        });
    });
</script>
	<script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawGenderChart);

      function drawGenderChart() {
        console.log('Attempting to draw gender distribution chart...');
        const container = document.getElementById('gender_piechart');
        if (!container) {
          console.error('Container for gender distribution chart not found!');
          return;
        }

        fetch('/api/gender-data')
          .then(response => response.json())
          .then(data => {
            var chartData = [['性別', '百分比']];
            Object.keys(data).forEach(gender => {
              chartData.push([gender, data[gender]]);
            });

            var googleData = google.visualization.arrayToDataTable(chartData);

            var options = {
              title: '',
              pieHole: 0.4,
            };

            var chart = new google.visualization.PieChart(container);
            chart.draw(googleData, options);
          })
          .catch(error => {
            console.error('Error fetching gender data:', error);
          });
      }
    </script>

	<script type="text/javascript">
      google.charts.load('current', {'packages':['bar']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        // 從後端獲取數據
        fetch('/api/reservations/field-usage-frequency')
          .then(response => response.json())
          .then(data => {
            // 準備數據
            var chartData = [
              ['場地', '第一', '第二', '第三']
            ];

            var fieldMapping = {
              '羽毛球場': ['羽毛球場', 0, 0, 0],
              '壁球場': ['壁球場', 0, 0, 0],
              '桌球桌': ['桌球桌', 0, 0, 0],
              '撞球桌': ['撞球桌', 0, 0, 0]
            };

            data.forEach(item => {
              console.log('Processing item:', item);  // 日誌記錄
              let match = item.field.match(/^(第一|第二|第三)(.*)$/);
              if (match) {
                let index;
                switch (match[1]) {
                  case '第一':
                    index = 1;
                    break;
                  case '第二':
                    index = 2;
                    break;
                  case '第三':
                    index = 3;
                    break;
                  default:
                    index = 0;
                }
                let field = match[2];
                if (fieldMapping[field]) {
                  fieldMapping[field][index] = item.usage_count;
                } else {
                  console.error(`Unexpected field type: ${field}`);
                }
              } else {
                console.error(`Unexpected field format: ${item.field}`);
              }
            });

            for (let key in fieldMapping) {
              chartData.push(fieldMapping[key]);
            }

            var googleData = google.visualization.arrayToDataTable(chartData);

            // 設置圖表選項
            var options = {
              chart: {
                title: '',
                subtitle: '',
              }
            };

            // 創建圖表並繪製
            var chart = new google.charts.Bar(document.getElementById('columnchart_material'));

            chart.draw(googleData, google.charts.Bar.convertOptions(options));
          })
          .catch(error => {
            console.error('Error fetching field usage frequency data:', error);
          });
      }
    </script>

	<script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'bar']});

      // 當Google圖表加載完成時，調用所有的繪製函數
      google.charts.setOnLoadCallback(drawAllCharts);

      function drawAllCharts() {
        drawTimeSlotChart();
        drawEquipmentChart();
      }

      // 繪製借用時段頻率分析的橫條圖
      function drawTimeSlotChart() {
        fetch('/api/reservations/time-slot-usage-frequency')
          .then(response => response.json())
          .then(data => {
            var chartData = [['時段', '借用次數']];
            const timeSlots = [
              "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00", 
              "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00",
              "16:00-17:00", "17:00-18:00", "19:00-20:00", "21:00-22:00"
            ];

            const usageCountMap = {};
            data.forEach(item => {
              usageCountMap[item.time] = item.usage_count;
            });

            timeSlots.forEach(slot => {
              chartData.push([slot, usageCountMap[slot] || 0]);
            });

            var googleData = google.visualization.arrayToDataTable(chartData);

            var options = {
              title: '',
              subtitle: '',
              hAxis: {title: '借用次數', minValue: 0},
              vAxis: {title: '時段'}
            };

            var chart = new google.visualization.BarChart(document.getElementById('barchart_material'));
            chart.draw(googleData, options);
          })
          .catch(error => {
            console.error('Error fetching time slot usage frequency data:', error);
          });
      }

      // 繪製是否借用球具的圓餅圖
      function drawEquipmentChart() {
        fetch('/api/reservations/equipment-usage-statistics')
          .then(response => response.json())
          .then(data => {
            var chartData = [['器具使用頻率', '借用次數']];
            Object.keys(data).forEach(key => {
              chartData.push([key, data[key]]);
            });

            var googleData = google.visualization.arrayToDataTable(chartData);

            var options = {
              title: '',
              pieHole: 0.4,
            };

            var chart = new google.visualization.PieChart(document.getElementById('piechart_material'));
            chart.draw(googleData, options);
          })
          .catch(error => {
            console.error('Error fetching equipment usage statistics:', error);
          });
      }
    </script>

	<!-- age analysis -->
	<script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'bar']});
      google.charts.setOnLoadCallback(drawAgeChart);

      function drawAgeChart() {
        console.log('Attempting to draw age distribution chart...');
        const container = document.getElementById('age_barchart');
        if (!container) {
          console.error('Container for age distribution chart not found!');
          return;
        }

        fetch('/api/age-data')
          .then(response => response.json())
          .then(data => {
            var chartData = [
              ['年齡分布', '人數'],
              ['18歲以下', data['18歲以下'] || 0],
              ['18到25歲', data['18到25歲'] || 0],
              ['26歲~35歲', data['26歲~35歲'] || 0],
              ['36歲~45歲', data['36歲~45歲'] || 0],
              ['46歲~55歲', data['46歲~55歲'] || 0],
              ['56歲~65歲', data['56歲~65歲'] || 0],
              ['65歲以上', data['65歲以上'] || 0]
            ];

            var googleData = google.visualization.arrayToDataTable(chartData);

            var options = {
              title: '',
              hAxis: {title: '年齡分布'},
              vAxis: {title: '人數'}
            };

            var chart = new google.visualization.ColumnChart(container);
            chart.draw(googleData, options);
          })
          .catch(error => {
            console.error('Error fetching age data:', error);
          });
      }
    </script>
	<script>
        // Wait for jsPDF to be available
        window.jsPDF = window.jspdf.jsPDF;

        // DataTable download button
        document.getElementById('downloadReservationTable').addEventListener('click', function() {
            var doc = new jsPDF();
            doc.autoTable({ html: '#reservationTable' });
            doc.save('reservation_table.pdf');
        });

        // Function to download chart as image
        function downloadChart(chartContainer, fileName) {
            html2canvas(chartContainer).then(canvas => {
                var imgData = canvas.toDataURL('image/png');
                var pdf = new jsPDF();
                pdf.addImage(imgData, 'PNG', 10, 10);
                pdf.save(fileName);
            });
        }

        // Gender chart download button
        document.getElementById('downloadGenderChart').addEventListener('click', function() {
            var chartContainer = document.getElementById('gender_piechart');
            downloadChart(chartContainer, 'gender_chart.pdf');
        });

        // Age chart download button
        document.getElementById('downloadAgeChart').addEventListener('click', function() {
            var chartContainer = document.getElementById('age_barchart');
            downloadChart(chartContainer, 'age_chart.pdf');
        });

        // Google Charts initialization and drawing functions
        google.charts.load('current', { 'packages': ['corechart', 'bar'] });
        google.charts.setOnLoadCallback(drawGenderChart);
        google.charts.setOnLoadCallback(drawAgeChart);

        // Draw gender chart
        function drawGenderChart() {
            var data = google.visualization.arrayToDataTable([
                ['性別', '百分比'],
                ['男性', 45],
                ['女性', 55]
            ]);
            var options = { title: '', pieHole: 0.4 };
            var chart = new google.visualization.PieChart(document.getElementById('gender_piechart'));
            chart.draw(data, options);
        }

        // Draw age chart
        function drawAgeChart() {
            var data = google.visualization.arrayToDataTable([
                ['年齡分布', '人數'],
                ['18歲以下', 3],
                ['18到25歲', 12],
                ['26歲~35歲', 25],
                ['36歲~45歲', 18],
                ['46歲~55歲', 7],
                ['56歲~65歲', 5],
                ['65歲以上', 2]
            ]);
            var options = { title: '', hAxis: { title: '年齡分布' }, vAxis: { title: '人數' } };
            var chart = new google.visualization.ColumnChart(document.getElementById('age_barchart'));
            chart.draw(data, options);
        }
    </script>

</body>

</html>
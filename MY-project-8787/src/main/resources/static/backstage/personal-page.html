<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">

<title>個人檔案</title>
<meta content="" name="description">
<meta content="" name="keywords">


<!-- Google Fonts -->
<link
	href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
	rel="stylesheet">

<!-- Vendor CSS Files -->
<link href="assets/vendor/aos/aos.css" rel="stylesheet">
<link href="assets/vendor/bootstrap/css/bootstrap.min.css"
	rel="stylesheet">
<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
	rel="stylesheet">
<link href="assets/vendor/boxicons/css/boxicons.min.css"
	rel="stylesheet">
<link href="assets/vendor/glightbox/css/glightbox.min.css"
	rel="stylesheet">
<link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

<!-- Template Main CSS File -->
<link href="assets/css/style.css" rel="stylesheet">

</head>

<body>

	<!-- ======= Mobile nav toggle button ======= -->
	<i class="bi bi-list mobile-nav-toggle d-xl-none"></i>

	<!-- ======= Header ======= -->
	<header id="header">
		<div class="d-flex flex-column">

			<div class="profile">
				<img src="assets/img/profile-img.jpg" alt=""
					class="img-fluid rounded-circle">
				<h1 class="text-light">
				<a href="./index.html" id="user-name">     </a>
				</h1>
			</div>

			<nav id="navbar" class="nav-menu navbar">
				<ul>
					<li><a href="./index.html" class="nav-link scrollto "><i
							class="bx bx-home"></i> <span>首頁</span></a></li>
					<li><a href="/backstage/my-register.html"
						class="nav-link scrollto "><i class="bx bx-book-content"></i>
							<span>我的預約</span></a></li>
					<li><a href="/backstage/register-history.html"
						class="nav-link scrollto"><i class="bx bx-server"></i> <span>我的練習紀錄</span></a></li>
				</ul>
			</nav>
			<!-- .nav-menu -->
		</div>
	</header>
	<!-- End Header -->

	<main id="main">

		<!-- ======= Breadcrumbs ======= -->
		<section class="breadcrumbs">
			<div class="container">

				<div class="d-flex justify-content-between align-items-center">
					<h2>個人檔案</h2>
					<ol>
						<li><a href="./index.html">首頁</a></li>
						<li>個人檔案</li>
					</ol>
				</div>

			</div>
		</section>
		<!-- End Breadcrumbs -->

		<section class="inner-page">
			<div class="container">
				<!-- Registration Form -->
				<form id="registrationForm">
					<div>
						<!-- Name Input Field -->
						<div class="mb-3">
							<label for="name" class="form-label">姓名</label> <input
								type="text" class="form-control" id="name"
								placeholder="Enter your name" required>
						</div>
						<!-- Gender Input Field -->
						<div class="mb-3">
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="gender"
									id="male" value="male"> <label class="form-check-label"
									for="male">男性</label>
							</div>
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="gender"
									id="female" value="female"> <label
									class="form-check-label" for="female">女性</label>
							</div>
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="gender"
									id="others" value="others" required> <label
									class="form-check-label" for="others">其他</label>
							</div>
						</div>
						<!-- Date Input Field -->
						<div class="mb-3">
							<label for="register-birthday" class="form-label">出生年月</label> <input
								type="date" class="form-control" id="register-birthday"
								placeholder="yyyy-mm-dd" required>
						</div>
						<!-- Phone Input Field -->
						<div class="mb-3">
							<label for="register-phone" class="form-label">行動電話</label> <input
								type="tel" class="form-control" id="register-phone"
								placeholder="09XXXXXXXX，共10碼">
							<div class="invalid-feedback">行動電話格式不正確，請輸入有效的手機號碼。</div>
						</div>
						<!-- Email Input Field -->
						<div class="mb-3">
							<label for="email" class="form-label">電子信箱</label> <input
								type="email" class="form-control" id="email"
								placeholder="name@example.com" required>
							<div class="invalid-feedback">請輸入有效的電子信箱。</div>
						</div>

						<!-- Submit Button -->
						<div class="mb-3">
							<button type="submit" class="btn btn-primary">更改資料</button>
						</div>
					</div>
				</form>

				<form id="ChangePasswordForm">
					<!-- Password Input Field -->
					<div class="mb-3">
						<label for="register-password" class="form-label">密碼</label> <input
							type="password" class="form-control" id="register-password"
							placeholder="請輸入你的密碼" required minlength="8">
						<div class="invalid-feedback">密碼至少要8個字元，且包含至少一個數字、小寫和大寫字母。</div>
					</div>
					<!--Repeat Password area-->
					<div class="mb-3">
						<label for="register-checkPassword" class="form-label">
							拜託再打一次密碼啦 </label> <input type="password" class="form-control"
							id="register-checkPassword"
							placeholder="密碼至少要8個字元，且包含至少一個數字、小寫和大寫字母" required minlength="8">
					</div>
						<div class="mb-3">
							<button type="submit" class="btn btn-primary">更改密碼</button>
						</div>
				</form>

			</div>
		</section>

	</main>
	<!-- End #main -->


	<a href="#"
		class="back-to-top d-flex align-items-center justify-content-center"><i
		class="bi bi-arrow-up-short"></i></a>

	<!-- Vendor JS Files -->
	<script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
	<script src="assets/vendor/aos/aos.js"></script>
	<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
	<script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
	<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
	<script src="assets/vendor/typed.js/typed.umd.js"></script>
	<script src="assets/vendor/waypoints/noframework.waypoints.js"></script>
	<script src="assets/vendor/php-email-form/validate.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

	<!-- Template Main JS File -->
	<script src="assets/js/main.js"></script>
	<script>
// update user name
document.addEventListener('DOMContentLoaded', function() {
    const email = sessionStorage.getItem('userEmail');
    if (email) {
        fetch(`/api/user-name?email=${email}`)
            .then(response => response.text())
            .then(name => {
                if (name) {
                    document.getElementById('user-name').innerText = `${name}您好`;
                } else {
                    document.getElementById('user-name').innerText = '使用者您好';
                }
            })
            .catch(error => console.error('Error fetching user name:', error));
    } else {
        console.error('No email found in sessionStorage.');
    }
});

document.addEventListener("DOMContentLoaded", function() {
    const today = new Date().toISOString().split('T')[0];
    const minDate = '1920-01-01';
    document.getElementById('register-birthday').setAttribute('max', today);
    document.getElementById('register-birthday').setAttribute('min', minDate);

    // 從會話存儲中讀取電子郵件
    let email = sessionStorage.getItem('userEmail');

    if (email) {
        // 獲取用戶資料
        fetch(`/api/users/${email}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.name) {
                    throw new Error('Invalid user data');
                }

                // 確認所有 DOM 元素存在
                const nameElement = document.getElementById('name');
                const birthdayElement = document.getElementById('register-birthday');
                const phoneElement = document.getElementById('register-phone');
                const emailElement = document.getElementById('email');
                const maleElement = document.getElementById('male');
                const femaleElement = document.getElementById('female');
                const othersElement = document.getElementById('others');

                if (!nameElement || !birthdayElement || !phoneElement || !emailElement || !maleElement || !femaleElement || !othersElement) {
                    throw new Error('One or more DOM elements not found');
                }

                // 填充用戶資料
                nameElement.value = data.name;
                birthdayElement.value = data.birthday;
                phoneElement.value = data.phone;
                emailElement.value = data.email;

                // 根據性別設置選中狀態
                if (data.gender === 'male') {
                    maleElement.checked = true;
                } else if (data.gender === 'female') {
                    femaleElement.checked = true;
                } else {
                    othersElement.checked = true;
                }
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '獲取用戶資料失敗',
                    text: '請稍後重試'
                });
            });
    } else {
        console.error('No email found in session storage');
        Swal.fire({
            icon: 'error',
            title: '未提供電子郵件',
            text: '請重新登錄'
        });
    }

    // 添加更新資料表單提交事件監聽器
    document.getElementById('registrationForm').addEventListener('submit', function(event) {
        event.preventDefault(); // 阻止表單默認提交行為

        // 獲取表單數據
        const name = document.getElementById('name').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const birthday = document.getElementById('register-birthday').value;
        const phone = document.getElementById('register-phone').value;
        const newEmail = document.getElementById('email').value;

        // 驗證表單數據
        const phoneRegex = /^09\d{8}$/;

        let valid = true;

        if (!phoneRegex.test(phone)) {
            document.getElementById('register-phone').classList.add('is-invalid');
            valid = false;
        } else {
            document.getElementById('register-phone').classList.remove('is-invalid');
        }

        if (!newEmail.includes('@')) {
            document.getElementById('email').classList.add('is-invalid');
            valid = false;
        } else {
            document.getElementById('email').classList.remove('is-invalid');
        }
        
        const birthdayDate = new Date(birthday);
        const minBirthdayDate = new Date(minDate);
        const maxBirthdayDate = new Date(today);

        if (birthdayDate < minBirthdayDate || birthdayDate > maxBirthdayDate) {
            document.getElementById('register-birthday').classList.add('is-invalid');
            valid = false;
        } else {
            document.getElementById('register-birthday').classList.remove('is-invalid');
        }

        if (!valid) {
            return;
        }

        const updatedUserData = {
            name: name,
            gender: gender,
            birthday: birthday,
            phone: phone,
            email: newEmail
        };

        // 發送更新請求到後端
        fetch(`/api/users/${email}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedUserData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            Swal.fire({
                icon: 'success',
                title: '資料更新成功',
                text: '資料已成功更新'
            });
            // 更新成功後，將新的電子郵件存儲到會話存儲中
            email = newEmail;
            sessionStorage.setItem('userEmail', newEmail);
        })
        .catch(error => {
            console.error('Error updating user data:', error);
            Swal.fire({
                icon: 'error',
                title: '更新資料失敗',
                text: '請稍後重試'
            });
        });
    });
});

document.getElementById('ChangePasswordForm').addEventListener('submit', function (event) {
    event.preventDefault();
    let password = document.getElementById('register-password').value;
    let confirmPassword = document.getElementById('register-checkPassword').value;
    if (password !== confirmPassword) {
        Swal.fire({
            icon: 'error',
            title: '錯誤',
            text: '兩次輸入的密碼不一致！'
        });
        return;
    }

    const email = sessionStorage.getItem('userEmail'); // 從sessionStorage中獲取用戶email

    fetch('/api/change-password', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email, password: password }), // 包含email
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '成功',
                text: '密碼更新成功'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '失敗',
                text: '密碼更新失敗：' + data.message
            });
        }
    })
    .catch((error) => {
        Swal.fire({
            icon: 'error',
            title: '錯誤',
            text: '發生錯誤，請稍後再試'
        });
        console.error('Error:', error);
    });
});

</script>

</body>

</html>